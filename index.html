<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snowfall total map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    
    <style>
		@font-face {
		font-family:"effra";
		src:url("https://use.typekit.net/af/bc093c/00000000000000007735fd41/30/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3") format("woff2"),url("https://use.typekit.net/af/bc093c/00000000000000007735fd41/30/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3") format("woff"),url("https://use.typekit.net/af/bc093c/00000000000000007735fd41/30/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3") format("opentype");
		font-display:auto;font-style:normal;font-weight:400;font-stretch:normal;
		}

		@font-face {
		font-family:"effra";
		src:url("https://use.typekit.net/af/c0864f/00000000000000007735fd3d/30/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3") format("woff2"),url("https://use.typekit.net/af/c0864f/00000000000000007735fd3d/30/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3") format("woff"),url("https://use.typekit.net/af/c0864f/00000000000000007735fd3d/30/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3") format("opentype");
		font-display:auto;font-style:normal;font-weight:700;font-stretch:normal;
		}

		@font-face {
		font-family: "effra";
		src: url("https://use.typekit.net/af/[font-id]/00000000000000007735fd[xx]/30/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3") format("woff2"),
			url("https://use.typekit.net/af/[font-id]/00000000000000007735fd[xx]/30/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3") format("woff"),
			url("https://use.typekit.net/af/[font-id]/00000000000000007735fd[xx]/30/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3") format("opentype");
		font-display: auto;
		font-style: italic;
		font-weight: 400;
		font-stretch: normal;
		}

		@font-face {
		font-family: 'Effra-Regular';
		src: local('effra');
		font-weight: 400;
		font-style: normal;
		}
    
		@font-face {
		font-family: 'Effra-Bold';
		src: local('effra');
		font-weight: 700;
		font-style: normal;
		}

        @font-face {
		font-family: 'Effra';
		src: local('effra');
		font-weight: 400;
		font-style: italic;
		}

		@font-face {
		font-family: 'Effra-Italic';
		src: local('effra');
		font-weight: 400;
		font-style: italic;
	}

	</style>

    <style>
    .source-sans-3-light {
        font-family: "Source Sans 3", sans-serif;
        font-optical-sizing: auto;
        font-weight: 300;
        font-style: normal;
    }

    .source-sans-3-regular {
        font-family: "Source Sans 3", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
    }

    .source-sans-3-bold {
        font-family: "Source Sans 3", sans-serif;
        font-optical-sizing: auto;
        font-weight: 700;
        font-style: normal;
    }
    </style>

    <style>
        body {
            padding: 0;
            color: #333;
            font-family: 'Effra', sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        #map {
            height: 800px;
            width: 100%;
        }
        
        .info-panel {
            left: 10px;
            bottom: 30px;
            color: #333;
            z-index: 1000;
        }

        .header {
            font-family: 'Effra-Bold', sans-serif;
            margin-bottom: 5px;
            line-height: 1.2;
        }
        
        .legend {
            color: #333;
            z-index: 1000;
            max-width: 300px;
            position: absolute;
            top: 800px;
            left: 30px;
            font-size: 1.125rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
        }
        
        .legend-gradient-bar {
            width: 100%;
            height: 15px;
            margin: 10px 0 5px 0;
            background: linear-gradient(to right,
                #d9f5fc 0%,
                #aed0eb 10%,
                #99aedb 30%,
                #5a71bc 50%,
                #363b84 70%,
                #ff1fa3 100%);
            border: 1px solid #ccc;
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            text-shadow: #333;
        }

        .footnote {
            position: relative;
        }

        .footnote p {
            margin: 5px 0;
            font-size: 1rem;
            color: #333;
            opacity: 0.8;
        }
        
        .info-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        /* Slider styles */
        .slider {
            position: absolute;
            top: 3px;
            left: 50px;
            bottom: 0px;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        #leaflet-slider {
            width: 300px;

        }

        #slider-timestamp {
            width: 300px;
            background-color: transparent;
            text-align: left;
            border-radius: 5px;
            padding: 13px;
            font-size: 1rem;
        }

        .ui-slider-handle {
            width: 14px !important;
            height: 14px !important;
            border-radius: 50% !important;
            background: #5a71bc !important;
        }

        .ui-slider {
            background: #ddd !important;
            border: none !important;
            /* height: 6px !important; */
        }

        .ui-slider-range {
            background: #5a71bc !important;
        }
    
        @media (max-width: 600px) {
            #map {
            height: 500px;
            
        }
            .legend {
                font-size: 1rem;
                top: 580px;
              
            }

            .legend-color {
                width: 15px;
                height: 10px;
            }

            .footnote {
                position: relative;
                top: auto;
                left: auto;
                width: 100%;
                max-width: none;
            }

            #leaflet-slider {
                width: 150px;
                
            }

            .slider {
                top: 3%;
                bottom: 0px;
                left: 50px;
                transform: scale(0.8);
               
            }
            .footnote p {
        
                font-size: 0.875rem;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>How much snow fell in your area?</h1>
        <p>Click a dot to see the amount of reported snowfall.</p>  
    </div>

    <div class="legend">
        <div><strong>Snowfall inches</strong></div>
        <div class="legend-gradient-bar"></div>
        <div class="legend-labels">
            <span>1</span>
            <span>&nbsp; 12</span>
            <span>24+</span>
        </div>
    </div>

    <div id="map"></div>
   
    <div class="footnote">
        <i><p id="generationTime">Loading...</p></i>
        <p>Map: Katrina Ventura/Get the Facts Data Team â€¢  Source: <a href="https://www.nohrsc.noaa.gov/snowfall_v2/" target="_blank">NWS National Gridded Snowfall Analysis</a></p>
    </div>

    <!-- jQuery and jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <!-- Leaflet scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // Leaflet Slider Control
        L.Control.SliderControl = L.Control.extend({
            options: {
                position: 'topleft',
                layer: null,
                timeAttribute: 'valid_time',
                isEpoch: true,
                startTimeIdx: 0,
                timeStrLength: 19,
                maxValue: -1,
                minValue: 0,
                showAllOnStart: false,
                markers: null,
                range: false,
                follow: false,
                sameDate: false,
                alwaysShowDate: true,
                rezoom: null
            },

            initialize: function (options) {
                L.Util.setOptions(this, options);
                this._layer = this.options.layer;
            },

            extractTimestamp: function(time, options) {
                if (options.isEpoch) {
                    const date = new Date(parseInt(time) * 1000);
                    return date.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true,
                        timeZone: 'America/New_York'
                    });
                }
                return time.substr(options.startTimeIdx, options.startTimeIdx + options.timeStrLength);
            },

            setPosition: function (position) {
                var map = this._map;
                if (map) {
                    map.removeControl(this);
                }
                this.options.position = position;
                if (map) {
                    map.addControl(this);
                }
                this.startSlider();
                return this;
            },

            onAdd: function (map) {
                this.options.map = map;

                var sliderContainer = L.DomUtil.create('div', 'slider', this._container);
                $(sliderContainer).append('<div id="leaflet-slider"><div class="ui-slider-handle"></div><div id="slider-timestamp"></div></div>');

                // var sliderContainer = L.DomUtil.create('div', 'slider', this._container);
                // $(sliderContainer).append('<div id="leaflet-slider" style="width:300px"><div class="ui-slider-handle"></div><div id="slider-timestamp" style="width:300px; margin-top:3px; margin-bottom:0px; background-color:transparent; text-align:left; border-radius:5px;"></div></div>');
                
                $(sliderContainer).mousedown(function () {
                    map.dragging.disable();
                });
                
                $(document).mouseup(function () {
                    map.dragging.enable();
                });

                var options = this.options;
                this.options.markers = [];

                if (this._layer) {
                    var index_temp = 0;
                    this._layer.eachLayer(function (layer) {
                        options.markers[index_temp] = layer;
                        ++index_temp;
                    });
                    options.maxValue = index_temp - 1;
                    this.options = options;
                } else {
                    console.log("Error: You have to specify a layer via new SliderControl({layer: your_layer});");
                }
                return sliderContainer;
            },

            onRemove: function (map) {
                for (var i = this.options.minValue; i <= this.options.maxValue; i++) {
                    if (this.options.markers[i]) {
                        map.removeLayer(this.options.markers[i]);
                    }
                }
                $('#leaflet-slider').remove();
                $(document).off("mouseup");
                $(".slider").off("mousedown");
            },

            startSlider: function () {
                var _options = this.options;
                var _extractTimestamp = this.extractTimestamp;
                var index_start = _options.minValue;
                
                if(_options.showAllOnStart){
                    index_start = _options.maxValue;
                    if(_options.range) _options.values = [_options.minValue,_options.maxValue];
                    else _options.value = _options.maxValue;
                }
                
                $("#leaflet-slider").slider({
                    range: _options.range,
                    value: _options.value,
                    values: _options.values,
                    min: _options.minValue,
                    max: _options.maxValue,
                    step: 1,
                    slide: function (e, ui) {
                        var map = _options.map;
                        
                        if(!!_options.markers[ui.value]) {
                            if(_options.markers[ui.value].feature !== undefined) {
                                if(_options.markers[ui.value].feature.properties[_options.timeAttribute]){
                                    $('#slider-timestamp').html(
                                        _extractTimestamp(_options.markers[ui.value].feature.properties[_options.timeAttribute], _options));
                                }
                            }

                            var i;
                            for (i = _options.minValue; i <= _options.maxValue; i++) {
                                if(_options.markers[i]) map.removeLayer(_options.markers[i]);
                            }
                            
                            for (i = _options.minValue; i <= ui.value ; i++) {
                                if(_options.markers[i]) {
                                    map.addLayer(_options.markers[i]);
                                }
                            }
                        }
                    }
                });
                
                if (!_options.range && _options.alwaysShowDate && _options.markers[index_start]) {
                    if (_options.markers[index_start].feature !== undefined) {
                        $('#slider-timestamp').html(_extractTimestamp(_options.markers[index_start].feature.properties[_options.timeAttribute], _options));
                    }
                }
                
                for (var i = _options.minValue; i <= index_start; i++) {
                    if (_options.markers[i]) {
                        _options.map.addLayer(_options.markers[i]);
                    }
                }
            }
        });

        L.control.sliderControl = function (options) {
            return new L.Control.SliderControl(options);
        };

        // Main map code
        const map = L.map('map', {
            center: [40, -95],
            zoom: 4.5,
            minZoom: 3,
            maxZoom: 10
        });
    
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 20,
            subdomains: 'abcd'
        }).addTo(map);
    
        let snowfallLayer = L.layerGroup().addTo(map);
        let sliderControl;
    
        function loadGeoJSON(geoJsonData) {
            snowfallLayer.clearLayers();
            
            if (sliderControl) {
                map.removeControl(sliderControl);
            }
            
            let sortedFeatures = [];
    
            if (geoJsonData.features) {
                // Sort features by time
                sortedFeatures = geoJsonData.features.sort((a, b) => 
                    a.properties.valid_time - b.properties.valid_time
                );

                // Create markers for each feature
                sortedFeatures.forEach(feature => {
                    const coords = feature.geometry.coordinates;
                    const amount = feature.properties.amount;
                    const location = feature.properties.location;
                    const state = feature.properties.state;
                    const time = feature.properties.valid_time;
                    const lat = coords[1];
                    const lon = coords[0];

                    const formattedTime = new Date(time * 1000).toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true,
                        timeZone: 'America/New_York'
                    });

                    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW', 
                        'NNE', 'ENE', 'ESE', 'SSE', 'SSW', 'WSW', 'WNW', 'NNW'];

                    const pattern1 = new RegExp(`^\\d+\\s+(${directions.join('|')})\\s+`, 'i');
                    let cleanLocation = location.replace(pattern1, '');

                    const pattern2 = new RegExp(`\\b(${directions.join('|')})\\b\\s*`, 'gi');
                    cleanLocation = cleanLocation.replace(pattern2, '');

                    const formattedLocation = cleanLocation.replace(/\b\w/g, char => char.toUpperCase());

                    const colorGradient = 
                        amount < 1 ? '#d9f5fc' :
                        amount <= 6 ? '#aed0eb' :
                        amount < 12 ? '#99aedb' :
                        amount <= 20 ? '#5a71bc' :
                        amount <= 24 ? '#363b84' :
                        amount <= 30 ? '#ff1fa3' :
                        '#d9f5fc';

                    let marker = L.circleMarker([lat, lon], {
                        radius: 6,
                        fillColor: colorGradient,
                        color: colorGradient,
                        weight: 1,
                        opacity: 0.5,
                        fillOpacity: 0.5
                    });

                    marker.feature = feature;

                    marker.bindPopup(`<strong>${formattedLocation}, ${state}</strong>
                        <br/>Snowfall: ${amount} ${amount >= 1 ? 'inches' : 'inch'}
                        <br/>Time: ${formattedTime}
                    `);
                    
                    snowfallLayer.addLayer(marker);
                });

                console.log(`Loaded ${sortedFeatures.length} snowfall points.`);

                // Add slider control
                sliderControl = L.control.sliderControl({
                    layer: snowfallLayer,
                    timeAttribute: 'valid_time',
                    isEpoch: true,
                    showAllOnStart: true,
                    alwaysShowDate: true
                });

                map.addControl(sliderControl);
                sliderControl.startSlider();
            }
        }

        function loadData() {
            fetch('https://www.weather.gov/source/crh/lsr_snow.geojson')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Raw API data:', data);
                    loadGeoJSON(data);
                    
                    const generationTime = new Date(data.generation_time);
                    const formattedTime = generationTime.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'America/New_York',
                        timeZoneName: 'short'
                    });
                    document.getElementById('generationTime').textContent = `Data as of ${formattedTime}`;
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('generationTime').textContent = 'Data unavailable';
                });
        }

        loadData();
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>